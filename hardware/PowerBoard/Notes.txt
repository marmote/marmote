------------------------------------------------------------------------------
-- MODULE: Power Board - Power management module for the Marmote platform
-- PROJECT: Marmote
-- AUTHORS: Sandor Szilvasi
-- AUTHOR CONTACT INFO.: Sandor Szilvasi <sandor.szilvasi@vanderbilt.edu>
-- TOOL VERSIONS: Eagle 5.11.0
--   
-- Copyright (c) 2006-2011, Vanderbilt University
-- All rights reserved.
--
-- Permission to use, copy, modify, and distribute this hardware design and its
-- documentation for any purpose, without fee, and without written agreement is
-- hereby granted, provided that the above copyright notice, the following
-- two paragraphs and the author appear in all copies of this software.
--
-- IN NO EVENT SHALL THE VANDERBILT UNIVERSITY BE LIABLE TO ANY PARTY FOR
-- DIRECT, INDIRECT, SPECIAL, INCIDENTAL, OR CONSEQUENTIAL DAMAGES ARISING OUT
-- OF THE USE OF THIS SOFTWARE AND ITS DOCUMENTATION, EVEN IF THE VANDERBILT
-- UNIVERSITY HAS BEEN ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
--
-- THE VANDERBILT UNIVERSITY SPECIFICALLY DISCLAIMS ANY WARRANTIES,
-- INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY
-- AND FITNESS FOR A PARTICULAR PURPOSE.  THE SOFTWARE PROVIDED HEREUNDER IS
-- ON AN "AS IS" BASIS, AND THE VANDERBILT UNIVERSITY HAS NO OBLIGATION TO
-- PROVIDE MAINTENANCE, SUPPORT, UPDATES, ENHANCEMENTS, OR MODIFICATIONS.
------------------------------------------------------------------------------

Power Board - Power management module for the Marmote platform
http://code.google.com/p/marmote

Eagle design guidelines: http://code.google.com/p/marmote/wiki/EagleDesignGuide

--------------------------------------------------------------------------------
				  Power Supply
--------------------------------------------------------------------------------


-------------
-- LTC3677 --
-------------

OVGATE nFET source connected to V_BUS (page 16)
- Why V_BUS? (PV: must be a typo in the datasheet, nFET source should act as the source of the PMIC external input)

V_INLDO2 feedback difference between p42 and p44
- Buck 1 feeds LDO2, which is a reverse sequence of the default power-on
  sequence (LOD2 -> Buck1 -> Buck 2)

Power-Up sequence depends on:

- V_INxx feedbacks
- DV_CC feedback of PWR_ON controller
- Power-up sequence: LDO2 -> Buck1 -> Buck2


-------------
-- Battery --
-------------

-Maximum charging current is selected to be 1000 mA (RPROG = 1k)
-Battery capacity is expected to be in the range of 4000-6000 mAh

Power Sources
-------------

Power Rails (Outputs)
-----------

Notes
-----

[Known Bugs]


--------------------------------------------------------------------------------
				 Power Monitor
--------------------------------------------------------------------------------


Current Senses
--------------

  * Digital 3.3V (D3V3 from BUCK1)
  * Digital 1.5V (D1V5 from BUCK2)
  * Digital X.YV where the X.Y value is programmable via a digital potentiometer
    (DXVY from BUCK3)
  * Analog 3.3V (A3V3 from LDO1)
  * Analog 1.5V (A1V5 from LDO2)
  * Highest available source (VOUT)
    - only the current portion flowing through the East and West bridges is
      measured (that is it does not include include local board consumption)
  * BAT
    - Measured with battery gas gauge LTC2942-2
    - R_SENSE = 50 mohm seems to be adequate (see notes)
      - 1000 mA maximum charge/discharge current
      - using large capacity (4000-6000 mAh) battery register overflow is expected
        (to be handled from SW in the microcontroller)
    -50 mohm R_SENSE is available as INTERNAL resistor in LTC2942-2

Notes
-----

  * The current of the power lines from the USB (VBUS) and the wall adapter
    (WALL) is not monitored

  * The voltage of VOUT is not measured, thus the power consumption on this
    line can only be estimated when it is operated from a battery (battery
    gas gauge voltage measurement)

  * All current monitors use AGND as reference except for the battery line,
    which uses DGND

  * All power rails are monitored with MAX9938 (G=50 V/V) current sense
    amplifier except for the one on the battery line

  * All current monitors use R_SENSE = 50 mohm

    - I_MAX = 1000 mA, U_REF = 3.3V (1.5V), G = 50 V/V, U_OUT,MAX = 3V
    - U_R, SENSE = R_SENSE x I_MAX < U_OUT,MAX / G

		   R_SENSE < 60 mohm
		   -----------------
		   R_SENSE = 50 mohm



--------------------------------------------------------------------------------
				Microcontroller
--------------------------------------------------------------------------------

  * STM32F102B ARM Cortex-M3 based microcontroller

  * Power sources

    - D3V3_STM always on digital 3.3V

  * Clock sources

    - 16 MHz external crystal (HSE, USB)
	- 32.768 kHz external crystal (LSE, not pupulated by default)

  * Reset signal

    - External reset via jumper

  * Programmer interfaces

	- SWD:  primary progammer interface, w/ SWTRACE (Programmer connector)
	- JTAG: secondary programmer interface, TDI and RESET are not connected by
	  default (Programmer connector)
	- USB:  USB programming is NOT supported (USB connector)

	- SmartFusion: the microcontroller may be capable of program the SmartFusion
	  MSS and FPGA fabric via emulating JTAG on its GPIO pins (West bridge)

  * Communication interfaces

    - I2C1: SmartFusion board
    - I2C2: LTC3677 (0001001), LTC2942 (1100100), MAX5419L (0101000)
    - SPI1: SmartFusion Board
    - SPI2: microSD card

  * GPIO pin requests

    Note: '+' before the pin name means it is connected (available),
	      '-' means the IC pin is not connected (unavailable) to the
		  microcontroller

	- LTC3677
	  - #CHRG (available via I2C)
	  + I_LIM0 (if I_LIM0 and I_LIM1 are connected, 1x and 5x modes are available)
	  + I_LIM1
	  - EN3 (became always on via pull-up)
	  + #EXTPWR
	  - PBSTAT (left open)
	  + PWR_ON (shared with main power switch, other options are always on
	    (pull-up) and another pin)
	  - PGOOD (available via I2C)
	  - #ACPR (#EXTPWR is already available)

	- LTC2942
	  + #AL/CC



--------------------------------------------------------------------------------
				     Parts
--------------------------------------------------------------------------------

Power managment IC
------------------
LTC3677-3 | WFQFN-44 | LTC3677EUFF-3#PBF-ND | LTC3677EUFF-3#PBF | http://search.digikey.com/scripts/DkSearch/dksus.dll?Detail&name=LTC3677EUFF-3%23PBF-ND
XC6210 LDO | SOT-25 | 893-1075-1-ND | XC6210B332MR-ND | http://search.digikey.com/scripts/DkSearch/dksus.dll?vendor=0&keywords=xc6210

Reverse voltage/overvoltage protection
--------------------------------------
pFET | SOT-23-3 | SI2333DS-T1-E3 | | http://search.digikey.com/scripts/DkSearch/dksus.dll?Detail&name=SI2333DS-T1-E3CT-ND
nFET | SOT-23-3 | SI2306BDS-T1-GE3 | | http://search.digikey.com/scripts/DkSearch/dksus.dll?Detail&name=SI2306BDS-T1-GE3CT-ND
Zener diode (5.6V) | 0603 | 641-1030-1-ND | CZRU52C5V6 | http://search.digikey.com/scripts/DkSearch/dksus.dll?Detail&name=641-1030-1-ND

Analog power
------------
Ferrite bead | 0603 | 490-5208-6-ND | http://search.digikey.com/scripts/DkSearch/dksus.dll?Detail&name=490-5208-2-ND

Battery
-------
NTC (100kohm 1% 1%) | 0603 | 445-2556-6-ND | http://search.digikey.com/scripts/DkSearch/dksus.dll?Detail&name=445-2556-6-ND
R (1%) | 0603 | | |

LT3677-3 LDO & BUCK
-------------------
R (510k 1%) | 0603 |
R (160k 1%) | 0603 |
R (140k 1%) | 0603 |
R ( 36k 1%) | 0603 |
L (4.7uH) | 445-3174-1-ND | VLCF4018T-4R7N1R0-2 | http://search.digikey.com/scripts/DkSearch/dksus.dll?Detail&name=445-3174-1-ND
L (3.3uH) | 445-3173-1-ND | VLCF4018T-3R3N1R2-2 | http://search.digikey.com/scripts/DkSearch/dksus.dll?Detail&name=445-3173-1-ND

Digital potentiometer
MAX5419 | DFN-8 | MAX5418LETA+TCT-ND| http://search.digikey.com/scripts/DkSearch/dksus.dll?Detail&name=MAX5418LETA%2BTCT-ND
http://datasheets.maxim-ic.com/en/ds/MAX5417-MAX5419.pdf


Microcontroller
---------------
STM32F102CBT6 | LQFP-48 | STM32F102CBT6 | http://search.digikey.com/scripts/DkSearch/dksus.dll?Detail&name=497-8308-ND

Current Monitors
----------------
LTC2942-2 | DFN-6    | 
MAX9938   | SOT-23-5 |

Passives
--------



--------------------------------------------------------------------------------
				   Todo List
--------------------------------------------------------------------------------

Library
-------

  * Touch-up transistor symbols (gate connector to middle)
  * Fix all designator prefixes
  * Add recommended layout to DFN6 package documentation layer


Schematic
---------

  * LTC3677 EN3 pin (currently simple pull-up)

  * CHECK IF POWER SEQUENCE UP IS STILL FINE (if not, move the master switch or
    replace BUCK1 with BUCK3)

  * Check if reverse board-mount protection is adequate (currently shifted
    connectors and screws only)
  * Check if battery connector orientation (standing/sideways)
  * PJ-014D Drill or Hole? (PV: these should be "Hole"-s. There are two types of holes on the PCB: "plated hole" (="via" or "pad" in Eagle) and "non-plated hole" (="hole" in Eagle). All three will generate "drill"-s automatically.)

  * Replace USB ESD diodes with ST USBLC6-2 SOT-23 IC


Board
-----

  * Connect LTC2942-2 pin 2 directly to the negative battery terminal
  * Check power jack pin connections in the device
  * Add fiducials
  * Add M-4-40 screws for the Base Board (similar to that of the USRP)
  * Add bottom silicon stands (~SmartFusion Eval Board)
  * LEDs should be moved towards the side of the board


--------------------------------------------------------------------------------
				   Questions
--------------------------------------------------------------------------------

  * Current placement of the inter-board connectors does not allow for
    interchangeable separated sensor boards (mirrored layout for East and West
	side boards)

  * Are bypass capacitors needed on the WALL line in between the transistors?
  * Is the transistor on #ACPR and WALL really necessary? (e.g. is the one on
    LTC4361 GATEP enough or can the two be combined together?)
  * LTC4351-1 or -2?


--------------------------------------------------------------------------------
				    Testing
--------------------------------------------------------------------------------

List of functionalities to test upon the reception of the manufactured board.

  * Test for the best PWR_ON connection before attaching the Li-Ion battery, as
    the corresponding DNP and R = 0 components are placed on the bottom side
	(Note: DNP marked components are generally placed on the top side).
  * Power on sequence
  * Power line voltages
